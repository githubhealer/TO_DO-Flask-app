<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agenda View</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        body {
            background-color: #1e1e2f;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }
        h1, h3 {
            font-weight: 600;
        }
        .agenda-task {
            background: #2e8b8b;
            color: #fff;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.95rem;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .form-control, .btn {
            border-radius: 8px;
        }
        .btn-outline-light {
            border-color: #fff;
            color: #fff;
        }
        .btn-outline-light:hover {
            background-color: #fff;
            color: #000;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4 text-center">Agenda View</h1>

    <!-- Show Calendar Button -->
    <button class="btn btn-info mb-4" onclick="showCalendarModal()">Show Calendar</button>

    <!-- Calendar Modal -->
    <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title" id="calendarModalLabel">Calendar</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="calendar"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function showCalendarModal() {
        var calendarModal = new bootstrap.Modal(document.getElementById('calendarModal'));
        calendarModal.show();

        // Render calendar only once
        if (!window.calendarRendered) {
          const calendarEl = document.getElementById('calendar');
          window.fcCalendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: "auto",
            events: [
              {% for date, tasks in tasks_by_date.items() %}
                {% for task in tasks %}
                {
                  title: "{{ task.text }}",
                  start: "{{ date }}",
                  url: "{{ url_for('day_view', date=date) }}?slot=30"
                },
                {% endfor %}
              {% endfor %}
            ],
            eventClick: function(info) {
              info.jsEvent.preventDefault();
              if (info.event.url) {
                window.location.href = info.event.url;
              }
            }
          });
          window.fcCalendar.render();
          window.calendarRendered = true;
        }

        // Fix: When modal is fully shown, update calendar size
        document.getElementById('calendarModal').addEventListener('shown.bs.modal', function () {
          if (window.fcCalendar) {
            window.fcCalendar.updateSize();
          }
        }, { once: true });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Go to Task Page Button -->
    <form action="" method="get" class="mt-4" onsubmit="event.preventDefault(); goToTaskPage();">
        <div class="row">
            <div class="col-md-6">
                <input type="date" id="gotoDate" class="form-control" required
                    value="{{ now().strftime('%Y-%m-%d') }}">
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary w-100">Go to Task Page</button>
            </div>
        </div>
    </form>
    <script>
        function goToTaskPage() {
            const date = document.getElementById('gotoDate').value;
            if (date) {
                window.location.href = `/day/${date}?slot=30`;
            }
        }
    </script>
    <hr>
    <h3>Pomodoro Timer</h3>
    <form id="pomodoroForm" onsubmit="startPomodoro(event)">
        <label>Work (minutes):</label>
        <input type="number" id="workDuration" value="25" min="0.05" step="0.05" required>
        <label class="ms-2">Break (minutes):</label>
        <input type="number" id="breakDuration" min="0.1" value="5" step="0.1" required>
        <button type="submit" class="btn btn-primary ms-2">Start</button>
        <button type="button" class="btn btn-danger ms-2" onclick="stopPomodoro()">Stop</button>
    </form>
    <p id="pomodoroDisplay" class="mt-3"></p>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for date, tasks in tasks_by_date.items() %}
        <div class="col">
            <div class="card bg-dark text-white h-100">
                <div class="card-header text-info">
                    <a href="{{ url_for('day_view', date=date) }}?slot=30" class="text-info text-decoration-none">{{ date }}</a>
                </div>
                <div class="card-body">
                    {% for task in tasks %}
                    <div class="agenda-task mb-2" id="task-{{ date }}-{{ loop.index0 }}">
                        <span id="task-text-{{ date }}-{{ loop.index0 }}" {% if task.completed %} style="text-decoration: line-through" {% endif %}>
                            {{ task.text }}
                        </span>
                        {% if not task.completed %}
                            <div class="mt-2">
                                <a class="btn btn-sm btn-outline-light" href="{{ url_for('complete_task', date=date, task_id=loop.index0) }}">‚úî</a>
                                <button class="btn btn-sm btn-warning" onclick="showEditForm('{{ date }}', '{{ loop.index0 }}', '{{ task.text|escape }}')">‚úèÔ∏è</button>
                            </div>
                        {% endif %}
                        <div id="edit-form-{{ date }}-{{ loop.index0 }}" style="display: none;" class="mt-2">
                            <form action="{{ url_for('edit_task', date=date, task_id=loop.index0) }}" method="post" class="d-flex gap-2">
                                <input type="hidden" name="next" value="agenda">
                                <input type="text" class="form-control" name="new_text" value="{{ task.text }}" required>
                                <button type="submit" class="btn btn-success btn-sm">üíæ</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="hideEditForm('{{ date }}', '{{ loop.index0 }}')">‚úñ</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <form action="{{ url_for('clear_all_tasks') }}" method="post" style="display:inline;">
        <button type="submit" class="btn btn-danger mb-3 mt-4">Clear All Tasks</button>
    </form>

    <script>
        let pomoInterval;
        let isWork = true;
        let secondsLeft = 0;
        function showEditForm(date, taskId, text) {
            document.getElementById(`edit-form-${date}-${taskId}`).style.display = 'flex';
            document.getElementById(`task-text-${date}-${taskId}`).style.display = 'none';
        }
        function hideEditForm(date, taskId) {
            document.getElementById(`edit-form-${date}-${taskId}`).style.display = 'none';
            document.getElementById(`task-text-${date}-${taskId}`).style.display = 'inline';
        }
        function startPomodoro(event) {
            event.preventDefault();
            stopPomodoro();
            isWork = true;
            let workMinutes = parseFloat(document.getElementById('workDuration').value);
            let breakMinutes = parseFloat(document.getElementById('breakDuration').value);
            secondsLeft = Math.round(workMinutes * 60);
            updatePomodoroDisplay();
            pomoInterval = setInterval(function () {
                secondsLeft--;
                if (secondsLeft <= 0) {
                    isWork = !isWork;
                    const msg = isWork ? "Work Time!" : "Break Time!";
                    showNotification(msg);
                    secondsLeft = Math.round((isWork ? workMinutes : breakMinutes) * 60);
                }
                updatePomodoroDisplay();
            }, 1000);
        }
        function updatePomodoroDisplay() {
            let m = Math.floor(secondsLeft / 60);
            let s = secondsLeft % 60;
            let session = isWork ? "Work" : "Break";
            document.getElementById('pomodoroDisplay').textContent = `${session} Session: ${m}:${s.toString().padStart(2, '0')}`;
        }
        function stopPomodoro() {
            clearInterval(pomoInterval);
            document.getElementById('pomodoroDisplay').textContent = "Stopped";
        }
        function showNotification(msg) {
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notifications.");
                return;
            }
            if (Notification.permission === "granted") {
                new Notification("Timer Finished!", { body: msg });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("Timer Finished!", { body: msg });
                    }
                });
            }
        }
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    </script>
</div>
</body>
</html>
